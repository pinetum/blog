<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>測試文 &middot; qtlintw</title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  <link rel="stylesheet" href="/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="static/css/override_.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link href="/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="just a test.">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'Your Google Analytics tracking code', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-0b">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>qtlintw</h1>
      <p class="lead">一隻肥宅</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="/">Blog</a></li>
      
      <li class="sidebar-nav-item"><a href="/projects/">Projects</a></li>
      
      <li class="sidebar-nav-item"><a href="/resume/">Resume</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/pinetum"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/qtlintw"><i class="fa fa-linkedin-square fa-3x"></i></a>
      
      
      
      
      <a href="/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

    <p>Copyright &copy; 2017 <a href="/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">測試文</h1>
    <span class="post-date">Apr 18, 2017 &middot; <a href="/blog/2017/04/18/%E6%B8%AC%E8%A9%A6%E6%96%87/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="/categories/test">test</a>
    </span>
    

<h3 id="ch13-web-server-development">CH13 Web Server Development</h3>

<hr />

<p>本章學習重點
- 建立可存取的路徑
- 對可存取的路徑做權限管控
- 取得傳入的參數
- 對已存在的handler修改
- 使用RPC API</p>

<h4 id="建立可存取的路徑">建立可存取的路徑</h4>

<p>例如：<code>http://127.0.0.1:8069/my_module/books</code></p>

<ol>
<li>於controllers/<strong>init</strong>.py加入<code>import main</code></li>
<li>於<strong>init</strong>.py加入<code>import controllers</code></li>
<li>建立controllers/main.py</li>
</ol>

<pre><code class="language-python">from openerp import http
from openerp.http import request
class Main(http.Controller):
    @http.route('/my_module/books', type='http', auth='none')
    def books(self):
        records = request.env['library.book'].sudo().search([])
        result = '&lt;html&gt;&lt;body&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;'
        result += '&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;'.join(
                    records.mapped('name'))
        result += '&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;'
        return result
    @http.route('/my_module/books/json', type='json',
               auth='none')
    def books_json(self):
        records = request.env['library.book']\
                        .sudo().search([])
        return records.read(['name'])
</code></pre>

<ul>
<li><code>@http.route</code>:decorator，用來告知odoo此method是web accessible，且可以將多個網址路徑對應到同一個method中</li>

<li><p><code>return something</code>:根據decorator中定義的type需要回傳的物件會有所不同</p>

<ul>
<li><p><code>type='http'</code>:直接回傳字串，一般來說為HTML，或<code>request.render('template_name', {datas})</code>藉由template產生UI</p></li>

<li><p><code>type='json'</code>:直接回傳物件，decorator會幫忙轉換成json格式</p></li>
</ul></li>

<li><p><code>request</code>:為一靜態物件，會包含所有handled request的所有資訊其中<code>request.env</code>與model中的<code>self.env</code>是相同的</p></li>

<li><p>SESSION:</p>

<pre><code class="language-python">request.session['hello'] = 'world'
request.session.get('hello')
</code></pre></li>
</ul>

<h4 id="對可存取的路徑做權限管控">對可存取的路徑做權限管控</h4>

<p>修改<code>@http.route</code>中的auth參數
- <code>auth='none'</code>: 沒有任何驗證機制(user record is always empty)
- <code>auth='public'</code>: 假如想讓登入與未登入者都可以使用(user record is set to base.public_user)
- <code>auth='user'</code>(default): 只有登入的使用者可以使用</p>

<h4 id="取得傳入的參數">取得傳入的參數</h4>

<pre><code class="language-python">@http.route('/my_module/book_details', type='http',
               auth='none')
def book_details(self, book_id):
    record = request.env['library.book']
                    .sudo().browse(int(book_id))
    return u'&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;Authors: %s' % (
        record.name,  u', '.join(
        record.author_ids.mapped('name')) or 'none',
    )
@http.route(&quot;/my_module/book_details/&lt;model(\
                       'library.book'):book&gt;&quot;,
                       type='http', auth='none')
def book_details_in_path(self, book):
    return self.book_details(book.id)
</code></pre>

<ul>
<li><code>/my_module/book_details?book_id=1</code> for <code>book_details</code></li>
<li><code>/my_module/book_details/1</code> for <code>book_details_in_path</code></li>
</ul>

<h4 id="對已存在的handler修改">對已存在的handler修改</h4>

<ol>
<li>對Qweb template做replace</li>
<li>對要送給qweb的參數做修改</li>
<li>如果handler有接收參數，可以對參數做前置處理</li>
</ol>

<pre><code class="language-xml"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
       &lt;odoo&gt;
         &lt;template id=&quot;show_website_info&quot;
           inherit_id=&quot;website.show_website_info&quot;&gt;
           &lt;xpath expr=&quot;//dl[@t-foreach='apps']&quot; position=&quot;replace&quot;&gt;
         &lt;table class=&quot;table&quot;&gt;
           &lt;tr t-foreach=&quot;apps&quot; t-as=&quot;app&quot;&gt;
             &lt;th&gt;
               &lt;a t-att-href=&quot;app.website&quot;&gt;
               &lt;t t-esc=&quot;app.name&quot; /&gt;&lt;/a&gt;
             &lt;/th&gt;
             &lt;td&gt;&lt;t t-esc=&quot;app.summary&quot; /&gt;&lt;/td&gt;
           &lt;/tr&gt;
         &lt;/table&gt;
       &lt;/xpath&gt;
     &lt;/template&gt;
   &lt;/odoo&gt;
</code></pre>

<p>controllers/main.py:</p>

<pre><code class="language-python">from openerp import http
from openerp.addons.website.controllers.main import Website


    class Website(Website):
        @http.route()
        def website_info(self):
            result = super(Website, self).website_info()
            result.qcontext['apps'] = \
            result.qcontext['apps'].filtered(
                lambda x: x.name != 'website')
            return result

</code></pre>

<p>只會看對被過濾的app清單</p>

<h4 id="使用rpc-api">使用RPC API</h4>

<ol>
<li>XMLRPC

<ul>
<li>每次的呼叫都需要使用者ID與密碼</li>
<li>藉由路徑<code>/xmlrpc/2/object</code>使用<code>execte_kw</code>呼叫model中的method</li>
</ul></li>
<li>JSONRPC

<ul>
<li>僅需要於第一次先呼叫<code>/web/session/authenticate</code>往後的呼叫就不需再傳送使用者ID與密碼資訊(驗證資訊紀錄在HTTP Header)</li>
<li>odoo UI部分 幾乎都使用此發法 例如 <code>rpc.call()</code>, <code>model.method()</code> 等</li>
</ul></li>
</ol>

<p>範例:取得所有已安裝的module</p>

<p>使用 XMLRPC</p>

<pre><code class="language-python"> #!/usr/bin/env python2
import xmlrpclib
db = 'odoo9'
user = 'admin'
password = 'admin'
uid = xmlrpclib.ServerProxy(
    'http://localhost:8069/xmlrpc/2/common')
    .authenticate(db, user, password, {})
odoo = xmlrpclib.ServerProxy(
    'http://localhost:8069/xmlrpc/2/object')
installed_modules = odoo.execute_kw(
    db, uid, password, 'ir.module.module', 'search_read',
    [[('state', '=', 'installed')], ['name']], {'context':
    {'lang': 'fr_FR'}})
for module in installed_modules:
    print module['name']


</code></pre>

<p>使用 JSONRPC</p>

<pre><code class="language-python"> #!/usr/bin/env python2
import json
import urllib2
db = 'odoo9'
user = 'admin'
password = 'admin'
request = urllib2.Request(
    'http://localhost:8069/web/session/authenticate',
    json.dumps({
        'jsonrpc': '2.0',
        'params': {
            'db': db,
            'login': user,
            'password': password,
}, }),
    {'Content-type': 'application/json'})
result = urllib2.urlopen(request).read()
result = json.loads(result)
session_id = result['result']['session_id']
request = urllib2.Request(
        'http://localhost:8069/web/dataset/call_kw',
        json.dumps({
        'jsonrpc': '2.0',
        'params': {
            'model': 'ir.module.module',
            'method': 'search_read',
            'args': [
            [('state', '=', 'installed')],
['name'], ],
            'kwargs': {'context': {'lang': 'fr_FR'}},
        },
}), {
        'Content-type': 'application/json',
    })
    result = urllib2.urlopen(request).read()
    result = json.loads(result)
    for module in result['result']:
    print module['name']


</code></pre>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "blog-qtlin";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "blog-qtlin";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

